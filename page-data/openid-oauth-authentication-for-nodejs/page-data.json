{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/openid-oauth-authentication-for-nodejs/","result":{"data":{"site":{"siteMetadata":{"title":"NoSleep Javascript Blog"}},"markdownRemark":{"id":"b82feec3-799c-5098-bc22-478f955a2c3e","excerpt":"Table of Contents Introduction So what is OpenId Connect? That’s fine, but why should I care? Show me the code! A note on tooling Step 1: What are we building…","html":"<h2 id=\"table-of-contents\" style=\"position:relative;\">Table of Contents<a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"header-anchor after\">#</a></h2>\n<div class=\"toc\">\n<ul>\n<li><a href=\"#introduction\">Introduction</a></li>\n<li><a href=\"#so-what-is-openid-connect\">So what is OpenId Connect?</a></li>\n<li><a href=\"#thats-fine-but-why-should-i-care\">That’s fine, but why should I care?</a></li>\n<li>\n<p><a href=\"#show-me-the-code\">Show me the code!</a></p>\n<ul>\n<li><a href=\"#a-note-on-tooling\">A note on tooling</a></li>\n<li><a href=\"#step-1-what-are-we-building\">Step 1: What are we building?</a></li>\n<li><a href=\"#step-2-initializing\">Step 2: Initializing</a></li>\n<li><a href=\"#step-3-log-in\">Step 3: Log In</a></li>\n<li><a href=\"#step-4-persistent-session\">Step 4: Persistent Session</a></li>\n<li><a href=\"#step-5-log-out\">Step 5: Log Out</a></li>\n<li><a href=\"#step-6-putting-it-all-together\">Step 6: Putting it all together</a></li>\n<li><a href=\"#step-7-single-sign-on\">Step 7: Single Sign On</a></li>\n</ul>\n</li>\n<li><a href=\"#bonus-the-complete-sequence-diagram-of-oidc-authentication\">Bonus: the complete sequence diagram of oidc authentication</a></li>\n<li><a href=\"#bonus-what-are-the-access-refresh-and-id-tokens\">Bonus: what are the access, refresh and id tokens?</a></li>\n<li><a href=\"#exercise-1\">Exercise 1</a></li>\n<li><a href=\"#closing\">Closing</a></li>\n</ul>\n</div>\n<h2 id=\"introduction\" style=\"position:relative;\">Introduction<a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Let’s build the basic boilerplate for an OpenId Connect based Authentication mechanism\nfor our Node.js / Typescript app that supports SSO (Single Sign On experience) out of the box\nand that will fit very well with a microservice architecture with no statefulness added.</p>\n<p>This sort of setup is great for microservice architectures because</p>\n<ul>\n<li>it provides clear authentication (and authorization) interfaces based on industries best practices</li>\n<li>it works well with self contained auth tokens that can be used for communications across microservices</li>\n<li>it requires no extra stateful layers (such as session databases)</li>\n<li>it can be easily expanded to make up a Single Sign on experience across multiple apps and even across companies.</li>\n</ul>\n<h2 id=\"so-what-is-openid-connect\" style=\"position:relative;\">So what is OpenId Connect?<a href=\"#so-what-is-openid-connect\" aria-label=\"so what is openid connect permalink\" class=\"header-anchor after\">#</a></h2>\n<blockquote>\n<p>OpenId Connect (a.k.a oidc) is an <em>interoperable authentication protocol</em> based on the OAuth 2.0 family of specifications.</p>\n<p><a href=\"https://openid.net/connect/faq/\">src</a></p>\n</blockquote>\n<p>The line between OpenId and OAuth is blurry in practice and in learning material in the web the concepts\nare sometimes a mix and match of both.</p>\n<p>I like to think of OpenId and OAuth as a set of specifications that\ndefine standard APIs for Authentication and Authorization, respectively.</p>\n<blockquote>\n<p>OpenID Connect lets developers authenticate their users across websites and\napps without having to own and manage password files. For the app builder,\nit provides a secure verifiable, answer to the question:\n“What is the identity of the person currently using the browser or native app that is connected to me?”</p>\n<p><a href=\"https://openid.net/connect/faq/\">src</a></p>\n</blockquote>\n<p>This has enabled 3rd party Authentication providers and the always present “Log In with X”\nyou see around the web, such Auth providers include Google (the one we use in the example code),\nAuth0, Microsoft, Okta, among many others. <a href=\"https://openid.net/certification/\">See certified providers here</a></p>\n<p>Additionally, OpenId Connect can be used in enterprise settings like shared Auth and Identity provider\nacross many apps (think about Microsoft active directory, or Okta’s service)\nproviding a Single Sign On experience; and also as a way of structuring a microservice\narchitecture with multiple “clients” (OAuth lingo for applications that interact with the Auth Server).</p>\n<p>If you want to go down the rabbit hole and learn more check these resources out</p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=996OiexHze0\">Nate Barbettini’s OAuth and OpenId in plain English</a></li>\n<li><a href=\"https://developer.okta.com/blog/2019/10/21/illustrated-guide-to-oauth-and-oidc\">Okta’s Ilustrated Guide to Oauth and OpenId Connect</a></li>\n<li><a href=\"https://tools.ietf.org/html/rfc6749\">IEEE OAuth 2.0 RFC</a> (it is dense but has all the details)</li>\n</ul>\n<p>Here is a nice illustration of one of the most common ways of Authenticating with\nOAuth 2.0 and OpenId Connect: the authorization code flow</p>\n<p><img src=\"/46184ddba11a21c92840104b5eab19a9/flow1.svg\" alt=\"OAuth OpenId high level flow diagram\"></p>\n<blockquote>\n<p>Source: heavily inspired by this <a href=\"https://www.youtube.com/watch?v=996OiexHze0\">Nate Barbettini’s presentation</a></p>\n</blockquote>\n<h2 id=\"thats-fine-but-why-should-i-care\" style=\"position:relative;\">That’s fine, but why should I care?<a href=\"#thats-fine-but-why-should-i-care\" aria-label=\"thats fine but why should i care permalink\" class=\"header-anchor after\">#</a></h2>\n<p>OAuth 2.0 and oidc have become ever present in the modern application development landscape and\nalthough the tooling is really good and hides a lot of details chances are that you will still require\na decent high level understanding of what you are doing.</p>\n<p>This applies both to already existing applications and to the practice of designing and creating new\napplications with modern architectures such as microservice oriented one.</p>\n<p>I will try to find the sweet spot between comprehensive and high level coverage, let’s hope\nI can achieve it.</p>\n<h2 id=\"show-me-the-code\" style=\"position:relative;\">Show me the code!<a href=\"#show-me-the-code\" aria-label=\"show me the code permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Let’s build a simple application that uses OAuth 2.0 and oidc. The idea is to show</p>\n<ul>\n<li>how to use 3rd party Auth and Identity providers</li>\n<li>how to integrate those mechanisms with something familiar to the web platform: session cookies!</li>\n<li>how to easily manage sessions in the Request-Response web app cycle (no libs here!)</li>\n<li>how the session can be structured to be self contained for a stateless session management</li>\n<li>security implications</li>\n<li>how this application can be used to achieve SSO (single sign on experience across multiple apps)</li>\n</ul>\n<p>You can check the full code <a href=\"https://github.com/franleplant/sso-with-openid\">here</a>.</p>\n<h3 id=\"a-note-on-tooling\" style=\"position:relative;\">A note on tooling<a href=\"#a-note-on-tooling\" aria-label=\"a note on tooling permalink\" class=\"header-anchor after\">#</a></h3>\n<p>I have found a nice certified NodeJs library called <a href=\"https://github.com/panva/node-openid-client\">openid-client</a>, it is a nice library with\ndecent Typescript support that makes it very easy to integrate Identity providers.</p>\n<p>Another really cool thing about OpenId Connect is the concept of <a href=\"https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata\">Discovery</a> which\nbasically means that although there are a bunch of parameters involved in setting up a proper\noidc flow like multiple urls, encryption algorithms, public keys to verify tokens, etc;\nyou really just need to use one url and, if the client library you are using supports it, the client will\nuse this Discovery mechanism to look for a <a href=\"https://developers.google.com/identity/protocols/oauth2/openid-connect#discovery\">Discovery Document</a> that contains all the necessary parameters\nand you are good to go!. <code class=\"language-text\">openid-client</code> supports this!.</p>\n<h3 id=\"step-1-what-are-we-building\" style=\"position:relative;\">Step 1: What are we building?<a href=\"#step-1-what-are-we-building\" aria-label=\"step 1 what are we building permalink\" class=\"header-anchor after\">#</a></h3>\n<p>We are going to use a top-down approach, so first we are going to cover how the app\nworks at the business logic level and in later steps we are going to cover\nthe “lib” side of things where we implement the proper express middleware, session management,\ncookie storage, etc.</p>\n<p>The app is really simple, it has two content routes</p>\n<ul>\n<li><code class=\"language-text\">/</code> or the home where we show the “login” button and it is public.</li>\n<li><code class=\"language-text\">/private</code> were we display some information about the currently logged in user. If there is no user logged in we simply display an error.</li>\n</ul>\n<p>Here are some pictures:</p>\n<style>\n.screen-img img {\n  border: 3px solid #CCC;\n}\n</style>\n<div class=\"screen-img\">\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a206f12438f888385b39a4f2b0273f22/91f10/screen1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABKklEQVQoz62OyU7CABRF+x0ODGllbIFYZhnERBADMiiIgrLQhQvZ4x+6d01MjIlxgVhaTTSkx7Ybcau+l5Pc+/Jyc4WiL8hByU+oIKFEVArFHSp7NXbL+1SrdZKpLTbVFGo8TSqdI5HMEgjKiBsB3B4Rl9vLyqqLtXUPHq+EoISjKLJCICyjJjLELTLZArn8NvlCyQmLxlSCoQhhOUbI+veKPkTJj2SFRmJ2iRLpVNbyQYTe6YBur89R54T+YEir3aHT7Vn6nMHZ0Lof02i2rcZVypVvavUGzdYhF5dXjMc3jK5Hlu8gPEyeuLud8Hj/jPGmo8915g5zNG3uaF3XMQzjB/bNRtM0ptMXZrNXxwuLT5OP9wXmgn8ZAUxHmPaaf0dYNk7wkv7NfAHwA6HMtsDrswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Initial public screen with login link\"\n        title=\"Initial public screen with login link\"\n        src=\"/static/a206f12438f888385b39a4f2b0273f22/fcda8/screen1.png\"\n        srcset=\"/static/a206f12438f888385b39a4f2b0273f22/12f09/screen1.png 148w,\n/static/a206f12438f888385b39a4f2b0273f22/e4a3f/screen1.png 295w,\n/static/a206f12438f888385b39a4f2b0273f22/fcda8/screen1.png 590w,\n/static/a206f12438f888385b39a4f2b0273f22/efc66/screen1.png 885w,\n/static/a206f12438f888385b39a4f2b0273f22/91f10/screen1.png 992w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9613b16e4e1c9d8bcd95bda6862bff04/0f7d5/screen2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 108.1081081081081%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAADm0lEQVQ4y52UW28bRRTHV7zDJyi0NM2lTQNpkzQpubVxGse5VC0SICFe+gBI8Gl4QMA7EgJU8VS1VaUWwu0BpSWpL0lvib12GttZ73pv3vXuzp9zxnG7MqGVGOm3Z+bM7Jkz58wcJXniBJKz3egaeROLyQVcuvweps8lMDU1g+T8ImYSSSRm5zExeQ5Dw2MYHjmL3r5+HOvuw+EjXXjj8FEcev2IhMfK6YFBvD04gOMDJzEzm8T0+QsYG5vAmdFxMjyLd8anMEnGR0l3emgUg6eG0d1zHEe7etB1rBcDb52ijUYlPb39UBaXL2MuuYSFhYtYvviu9OTC3DxSqSWSKaQWlrG0fInWpJBIzMl53mTkzFmMT0zj/Q8+xCeffk58Jk+iPN7MIpvbIHLIZnNSptMZPHz0CMViiShKVLVFe9yeK6gq8vm8hMdKKEJ4fhONRgMNz4NHWLaNZhDg/zRFCPGieRGTURz6L6LGH8Rky2AcbgF5p+s6HMeBbdvCdV0wPGZJOvi+39qpw6MDDfLxOY4bm5tiff0+x9bPZDLlv9fWKul0urK6ulrWqLXtiVaT/ysdSg5cYJpmUC6XA0qCt7OzA8MwflWo0dxrxKvEK8QIrXfjBuMxFPvuS2Wz2ZTHYizL5kTdJfUgxWiS1kyQHCL5EeHFY/3MwygM0fQ9g/rfkfJ7kswPxLfEvfZi3q8zPI7rirppwqUwsYoNhur2E/yxcvvuz3dWeKy4AZQGJSyQG0Yf7zvA3oTPESxlwizTFJ7XaB3ZDyEM00FFMzWniS8tD18TXxHfEF84vvjT9SMQESE68SjqbIOl1yQPSnTQTdUUubyO3HYNaw92cW+jhPuPK1h/uIss6Uo6hFqLUDwAVXsOjxXdgagYPnZrDfFUc4NixQpKVbsF9UkfaVYEzQrFf4A9k2UE3ZExEi97TfHXchCxNa0s00X26K7VUavp4IxpWk32JbrBc4Ln63VTrtNIX93bg24YvEZUqlWZZZkU/hj1Op5sbSFfKGDn6S628wVsbVMFKaiCLnfI43Qme+XGzVuHVn77vf/2nV/6frz6UzcVkQe27dBG9aj9FKXBkO4hv9+4bPWpFoWR4D61v4hrxM19rhPWvy72S6rNszjGL3P8n3hxaL8UWUHovYLesJR0BKnjchT7h0tWSBUnJH1IBYT7co76ohGPoWVZKJcrMgl7FOwqBZnfcKdHLHlTDgEb4M1Z1y5p3P4B1uUI60DGan0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Authenticating with the oidc provider\"\n        title=\"Authenticating with the oidc provider\"\n        src=\"/static/9613b16e4e1c9d8bcd95bda6862bff04/fcda8/screen2.png\"\n        srcset=\"/static/9613b16e4e1c9d8bcd95bda6862bff04/12f09/screen2.png 148w,\n/static/9613b16e4e1c9d8bcd95bda6862bff04/e4a3f/screen2.png 295w,\n/static/9613b16e4e1c9d8bcd95bda6862bff04/fcda8/screen2.png 590w,\n/static/9613b16e4e1c9d8bcd95bda6862bff04/efc66/screen2.png 885w,\n/static/9613b16e4e1c9d8bcd95bda6862bff04/0f7d5/screen2.png 993w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/38ecb057c330665f2189718f37b62f20/0f7d5/screen3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACFUlEQVQoz52S0W4SQRSG9z2qQgtYWmEBhdIu7VIWCm0BGyKJNkavvFBvrBc+hKnBxGh8Ak24qr6DF4WCwZqYeFWTIstCIgki7LK78zsDtKm1JdGTfHt2zsx+ZyazXHTaifiyHY6gDR4+gCVRQjyxjmhsFWvraSQSSUSkFXh9AcwFQ/AHFuCcccHucMJiteGSZQoTFyyYuGiFlY45r8sLnndhxu1GYC5EEbAgiAgthiGGJQghkYoEuPmr8Hj9mL3Cwzppx+SUAzb7NFy8D4KwhPl5AY7Ls+A2MlkkUxmSSmdwI3uLSNG4HltZ1VPpjQHhZUkXw5FBDi2Kus/nN675g4RJIpEY2bx9F1uPHuPh/Qf0ZElwlUoFhUIBn/b3ye5uAXt7JZTLZRSLRZRKZdRqNTSbTShKA40GZfSuKAqpKwpkWcZhtYpq9TvYmGu1WmzSZB+12+0DXde3u91uTlXVnKZpOQBHPKc8pbyhmBgGwangmEiu1w25MRB+oDUnxUPhGZrW53s9lacNvLSRgzbcNIcBChnlYzhmPfj6BW9fPSO6YQzbEvIHR7VT8VdhsEP2aCuHZGf7CX52frFFBu1kUAGzH+cTmCdk5Ezh65cvyPXkGnbevSejRWS4KXJmHiv8XPmIe3du0l8mi3w+D61jQv72A31VP++oY4OjFzG4+oZSh6ap6HX6aCkd6H3j/4TjJv9VxuI3lzUMlUViVrgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Back to our private route in our app\"\n        title=\"Back to our private route in our app\"\n        src=\"/static/38ecb057c330665f2189718f37b62f20/fcda8/screen3.png\"\n        srcset=\"/static/38ecb057c330665f2189718f37b62f20/12f09/screen3.png 148w,\n/static/38ecb057c330665f2189718f37b62f20/e4a3f/screen3.png 295w,\n/static/38ecb057c330665f2189718f37b62f20/fcda8/screen3.png 590w,\n/static/38ecb057c330665f2189718f37b62f20/efc66/screen3.png 885w,\n/static/38ecb057c330665f2189718f37b62f20/0f7d5/screen3.png 993w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n</div>\n<p>There are at least two additional routes that have to do with the OAuth flow\nthat we will cover later.</p>\n<p>This is the <code class=\"language-text\">index.ts</code> that makes up the high level app implementation, think of this\nas a mix of the boilerplate plus the two domain / business specific routes.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Necessary for express to parse the cookies into a nice</span>\n<span class=\"token comment\">// higher level object</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cookieParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// initialises the Issuer and the Client</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span>initialize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Deals with the user session</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Adds the OAuth / OpenId necessary routes.</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">routes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// use the pre configured view engine</span>\n  <span class=\"token comment\">// to render the index.mustache file</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/private\"</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">.</span>requireAuth<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This is the main high level hook for the user</span>\n  <span class=\"token comment\">// session, we will be building this later</span>\n  <span class=\"token keyword\">const</span> claims <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>session<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>tokenSet<span class=\"token punctuation\">.</span><span class=\"token function\">claims</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// render private.mustache and interpolate</span>\n  <span class=\"token comment\">// the following data</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"private\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">:</span> claims<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n    picture<span class=\"token operator\">:</span> claims<span class=\"token punctuation\">.</span>picture<span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> claims<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Express started on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next we will cover more details (descending into the details).</p>\n<h3 id=\"step-2-initializing\" style=\"position:relative;\">Step 2: Initializing<a href=\"#step-2-initializing\" aria-label=\"step 2 initializing permalink\" class=\"header-anchor after\">#</a></h3>\n<p>First we need to initialize the <a href=\"https://github.com/panva/node-openid-client\">openid-client</a>\nIssuer (the one that discovers all the publicly available OpenId configuration) and later the Client\n(the one that we will use to make all the underlying HTTP calls).\nWe will abstract this step into a middleware and save the instances into the <code class=\"language-text\">req.app</code> object\nsince these things need to be instantiated once per app.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> NextFunction\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authIssuer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> googleIssuer <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Issuer<span class=\"token punctuation\">.</span><span class=\"token function\">discover</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"https://accounts.google.com\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">googleIssuer</span><span class=\"token punctuation\">.</span><span class=\"token function\">Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    client_id<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH_CLIENT_ID</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    client_secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH_CLIENT_SECRET</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    redirect_uris<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">getDomain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/auth/callback</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    response_types<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authIssuer <span class=\"token operator\">=</span> googleIssuer<span class=\"token punctuation\">;</span>\n  req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authClient <span class=\"token operator\">=</span> client<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note: <code class=\"language-text\">getDomain</code> is a thin helper that returns exactly this <code class=\"language-text\">http://${process.env.HOST}:${process.env.PORT}</code>.</p>\n<h3 id=\"step-3-log-in\" style=\"position:relative;\">Step 3: Log In<a href=\"#step-3-log-in\" aria-label=\"step 3 log in permalink\" class=\"header-anchor after\">#</a></h3>\n<p>We have a nice comprehensive sequence diagram of the all the HTTP redirects and\ninteractions that make up the complete OAuth / OpenId Connect authorization code flow\nbelow in a <a href=\"#bonus-the-complete-sequence-diagram-of-oidc-authentication\">bonus section</a></p>\n<p>In this step we are going to build the two endpoints necessary for this type of auth flow:</p>\n<ol>\n<li>Auth entry point: Create a route that redirects to the right oidc provider authentication page and that kicks starts the whole auth flow, in our case we simply called it: <code class=\"language-text\">/auth/login</code> but you can use whatever you like.</li>\n<li>Callback: Create a route that the oidc provider will redirect back from the auth page with the auth code that we will later exchange for the proper access, id and refresh tokens. In our case we simply called it <code class=\"language-text\">/auth/callback</code> but again it can be whatever you want it to be.</li>\n</ol>\n<p>We also encapsulated these routes into a nice middleware that we called <code class=\"language-text\">auth.routes</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Auth entry point.</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/login\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Check the full code to see a</span>\n  <span class=\"token comment\">// concrete implementation of this</span>\n  <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> <span class=\"token function\">calcState</span><span class=\"token punctuation\">(</span>extraContent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// calculate the url where we want to redirect to</span>\n  <span class=\"token keyword\">const</span> authUrl <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authClient<span class=\"token punctuation\">.</span><span class=\"token function\">authorizationUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    scope<span class=\"token operator\">:</span> <span class=\"token string\">\"openid email profile\"</span><span class=\"token punctuation\">,</span>\n    state<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">setAuthStateCookie</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span>authUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Callback</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/callback\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authClient<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// extract all the necessary query params</span>\n  <span class=\"token comment\">// like the authorization code.</span>\n  <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">callbackParams</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// read the state cookie</span>\n  <span class=\"token keyword\">const</span> state <span class=\"token operator\">=</span> <span class=\"token function\">getAuthStateCookie</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// exchange the authorization code for the access,</span>\n  <span class=\"token comment\">// refresh and id token, this is what makes up the</span>\n  <span class=\"token comment\">// main `Back channel` communication, it is considered</span>\n  <span class=\"token comment\">// more secure and will include client_id and client_secret.</span>\n  <span class=\"token keyword\">const</span> tokenSet <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">getDomain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/auth/callback</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    params<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// The lib will compare the state that the</span>\n    <span class=\"token comment\">// identity provider passes as params</span>\n    <span class=\"token comment\">// with the one we stored in the cookies.</span>\n    <span class=\"token punctuation\">{</span> state <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// We can fetch the userinfo (basic identity attributes)</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">userinfo</span><span class=\"token punctuation\">(</span>tokenSet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Set the session cookie,</span>\n  <span class=\"token comment\">// we could also set req.session but</span>\n  <span class=\"token comment\">// since we are returning immediately is not</span>\n  <span class=\"token comment\">// a must</span>\n  <span class=\"token keyword\">const</span> sessionCookie <span class=\"token operator\">=</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> tokenSet<span class=\"token punctuation\">,</span> user <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setSessionCookie</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> sessionCookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>check the <a href=\"https://github.com/franleplant/sso-with-openid\">complete code</a> to see how to implement logout and a back-to-original-route mechanism</li>\n</ul>\n<p>As you can see the <em>Auth entry point</em> is a very simple sync redirect to the Identity provider’s login,\nthe library is doing a lot of the work for us but the <code class=\"language-text\">authUrl</code> will contain the <code class=\"language-text\">client_id</code>,\nthe callback url <code class=\"language-text\">http://host:port/auth/callback</code> in our case, required <code class=\"language-text\">scopes</code>, etc.\nThis is also what we call the “Front channel” and it is considered not entirely secure, that is why\nwe are not sending the client secret at this stage, remember that this happens all in the browser via\nHTTP redirects.</p>\n<p>The <em>Callback</em> will be redirected from a successful login with the Identity provider and\nwill exchange the authorization code for the tokens (check inline comments).\nThis is the step where we more commonly deal with persistent sessions, notice that\nthe Identity Provider doesn’t deal with this and that’s something we need to deal with ourselves.</p>\n<p>Check the <code class=\"language-text\">state</code> parameter, this acts as a sort of <a href=\"https://en.wikipedia.org/wiki/Cross-site_request_forgery\">XSRF a.k.a. CSRF a.k.a. csurf</a> token that we can use to\nprevent XSRF attacks but also to store <em>state</em> across the OAuth flow. See exercise at the bottom for more info.\nCheck the <a href=\"https://github.com/franleplant/sso-with-openid\">full code</a> for a concrete but very simple working implementation.</p>\n<p>We are going to use a very simple self contained stateless strategy here, we will cover it in more details\nin the next section but at a high level what we are doing is setting a persistent cookie (the session cookie)\nthat will travel in all requests from the browser to our local server and that we will use to identify\nusers that already identified themselves.</p>\n<h3 id=\"step-4-persistent-session\" style=\"position:relative;\">Step 4: Persistent Session<a href=\"#step-4-persistent-session\" aria-label=\"step 4 persistent session permalink\" class=\"header-anchor after\">#</a></h3>\n<p>There are several ways of handling sessions but in most cases\nit all boils down to persisting a session across requests and\nidentifying requests with one or zero sessions, meaning, identifying the\nalready authenticated and identified users that are making requests to our app or simply\nacknowledging that there is no previously authenticated user.</p>\n<p>Sessions are most commonly persisted in the form of a long lived cookie in the browsers and\ntheir content might be a session id that is mapped to the session object in a database\nserver side which is the stateful solution; or the content might be the entire self contained session object,\nwhich is the stateless solution, this is a simpler approach that will work for us\nand that has its merits in the microservice architecture.</p>\n<blockquote>\n<p>Why do we care about stateless vs stateful? Having a self contained cookie means that we can\nknow certain facts about the authenticated users without having to either interact with a database\nor another service. Stateless is desired as much as possible because it is easy to horizontally scale\ni.e. adding more instances of the app running in other nodes in our cluster, whereas scaling stateful\nservices is another whole challenge (think about master slave relationship between databases,\nreplication, backup, consistency considerations, etc).\nThe typical solution for a stateful session is to store a simple session id in the browser and then associate\nthat id in a key value database such as <a href=\"https://redis.io/\">redis</a></p>\n</blockquote>\n<p><strong>When do we write the session cookie?</strong></p>\n<p>We write it at two main steps:</p>\n<ul>\n<li>after login in</li>\n<li>after refreshing the auth tokens (not necessary in a stateful session schema)</li>\n</ul>\n<p>We also clear it in two main steps:</p>\n<ul>\n<li>after logout</li>\n<li>after trying to refresh a token and the refresh token has expired.</li>\n</ul>\n<p><strong>And when do we read the session cookie? And what do we do with it?</strong></p>\n<p>This where the fun begins. We read the session cookie <em>on every request</em>,\nand if we find one then we are going to parse it into a session object or instance\nand store it in the <code class=\"language-text\">req</code> object, this fits super fine because the parsed, hydrated session\nobject only applies on a particular request, the next request might belong to another user or even\nto a non authenticated user.</p>\n<p>Why do we need to parse it? Basically, we will store it as string in the cookie and when\nwe read the cookie we are going to parse it back to an object, this is a very simple approach, more\ncommonly you will store the session as a base64 encoded json object to save space and later you will\nparse it into an instance of a class so that you can cache some results and provide certain useful methods\nto the rest of the app. In our case we simply reuse the <code class=\"language-text\">TokenSet</code> class with useful methods that\nthe <a href=\"https://github.com/panva/node-openid-client\">openid-client</a> lib provides.</p>\n<p>This is a nice illustration of the flow you will soon see in code:</p>\n<style>\n.flow2 img {\n max-width: 500px;\n}\n\n.flow2 p {\ntext-align: center;\n\n}\n</style>\n<div class=\"flow2\">\n<p><img src=\"/5ddf56d912b9307f2c486659a827916a/flow2.svg\" alt=\"Session Middleware flow diagram\"></p>\n</div>\n<p>Enough talk, let’s code:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">session</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> NextFunction\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> sessionCookie <span class=\"token operator\">=</span> <span class=\"token function\">getSessionCookie</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// If there is no session cookie it means there is no</span>\n  <span class=\"token comment\">// authenticated user associated with this request,</span>\n  <span class=\"token comment\">// no further work needed.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sessionCookie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authClient<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Parse the cookie into a TokenSet instance</span>\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token function\">deserialize</span><span class=\"token punctuation\">(</span>sessionCookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Refresh the tokens if necessary</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">.</span>tokenSet<span class=\"token punctuation\">.</span><span class=\"token function\">expired</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> refreshedTokenSet <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span>\n        session<span class=\"token punctuation\">.</span>tokenSet\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      session<span class=\"token punctuation\">.</span>tokenSet <span class=\"token operator\">=</span> refreshedTokenSet<span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// set the cookie with the refreshed tokens</span>\n      <span class=\"token function\">setSessionCookie</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// this can throw when the refresh</span>\n      <span class=\"token comment\">// token has expired,</span>\n      <span class=\"token comment\">// logout completely when that happens</span>\n      <span class=\"token function\">clearSessionCookie</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// We also verify that the tokens inside the cookie are valid</span>\n  <span class=\"token comment\">// with public keys mechanisms covered by the JWT spec.</span>\n  <span class=\"token comment\">// This is unfortunately a private method of the lib, but basically</span>\n  <span class=\"token comment\">// it grabs the id_token and decodes it as JWT with a public key</span>\n  <span class=\"token comment\">// that we got as part as the discovery process, if this succeeds it means</span>\n  <span class=\"token comment\">// that the token inside the cookie is a token that has been crated by our</span>\n  <span class=\"token comment\">// identity provided and thus it is secure and fine and we can trust it.</span>\n  <span class=\"token keyword\">const</span> validate <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>validateIdToken <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">.</span>tokenSet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bad token signature found in auth cookie\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bad Token in Auth Cookie!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// After all that work the only thing remaining is</span>\n  <span class=\"token comment\">// to store the valid session object into req.session</span>\n  <span class=\"token comment\">// for the rest of the app to use.</span>\n  req<span class=\"token punctuation\">.</span>session <span class=\"token operator\">=</span> session<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What might the rest of the app do with <code class=\"language-text\">req.session</code>?\nJust to give some ideas:</p>\n<ul>\n<li>check if there is a user logged in (i.e. only allowing to view certain content to authenticated users)</li>\n<li>display information about the logged in user, such as menu icons etc</li>\n<li>fetch data associated with a user to a database or another service</li>\n<li>check user permissions and create a more complex allow list of routes</li>\n<li>many many more things.</li>\n</ul>\n<p>The main point of this middleware (which is inspired by prior work such as\n<a href=\"https://www.npmjs.com/package/express-session\">express-session</a> and <a href=\"http://www.passportjs.org/\">Passport.js</a>) is to abstract all the logic of\nparsing the session cookie, refreshing if necessary and hydrating the <code class=\"language-text\">req.session</code> object\nin a single place, the rest of the app can rely on that being there and that nothing else will\nneed to be done there.</p>\n<p>We also have a nice example middleware that prevents non authenticated users to access\ncertain routes:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requireAuth</span><span class=\"token punctuation\">(</span>\n  req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span>\n  res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> NextFunction\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unauthenticated\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Of course this will only work if the <code class=\"language-text\">session</code> middleware runs first in the middleware chain\nand this runs later, that is why it is important that your session middleware to be run as early as possible,\nat least before your routes definitions.</p>\n<h3 id=\"step-5-log-out\" style=\"position:relative;\">Step 5: Log Out<a href=\"#step-5-log-out\" aria-label=\"step 5 log out permalink\" class=\"header-anchor after\">#</a></h3>\n<p>In here you have two options:</p>\n<ul>\n<li>Logging out of just your app</li>\n<li>Logging out entirely out of the identity provider</li>\n</ul>\n<p>We are going to use the first approach:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/logout\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>authClient<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> tokenSet <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>session<span class=\"token operator\">?.</span>tokenSet<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Make sure the access token we got from the identity provider</span>\n  <span class=\"token comment\">// gets revoked, this is for security reasons</span>\n  <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">revoke</span><span class=\"token punctuation\">(</span>tokenSet<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>access_token<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Clean up session cookies</span>\n  <span class=\"token function\">clearSessionCookie</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"step-6-putting-it-all-together\" style=\"position:relative;\">Step 6: Putting it all together<a href=\"#step-6-putting-it-all-together\" aria-label=\"step 6 putting it all together permalink\" class=\"header-anchor after\">#</a></h3>\n<p>With a little bit of express experience we can encapsulate all the previous logic\ninto nice middlewares and leave the rest of the app to deal with domain / business logic.</p>\n<p>We put all the authentication related code in the <code class=\"language-text\">auth</code> directory, and the high level api is\nmade up of middlewares. You can use middleware factories for more complex use cases (functions that accept\noptions and return middlewares, and yes, the router <em>is</em> a middleware).</p>\n<h3 id=\"step-7-single-sign-on\" style=\"position:relative;\">Step 7: Single Sign On<a href=\"#step-7-single-sign-on\" aria-label=\"step 7 single sign on permalink\" class=\"header-anchor after\">#</a></h3>\n<p>Single Sign On (SSO) means that if you are already authenticated with one app using the same\nOpenId Identity Provider then you will be almost automatically authenticated we other apps.</p>\n<p>We have set a nice example in the repo, check instructions to see it in action <a href=\"https://github.com/franleplant/sso-with-openid\">here</a>.</p>\n<p>How does it work?</p>\n<ul>\n<li>the Session cookie is completely independent in each app (see the domain note on the repo’s README).</li>\n<li>If you already logged in with app1 then when you try to login with app2 then you won’t need to introduce your credentials and the OAuth flow will happen without you (the user) needing to do anything, that is why I say it is almost automatic.</li>\n</ul>\n<h2 id=\"bonus-the-complete-sequence-diagram-of-oidc-authentication\" style=\"position:relative;\">Bonus: the complete sequence diagram of oidc authentication<a href=\"#bonus-the-complete-sequence-diagram-of-oidc-authentication\" aria-label=\"bonus the complete sequence diagram of oidc authentication permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Most of the time you will see this sequence diagram simplified, but I wanted\nto show you in full details all the steps and http redirects there are inside this\ntransaction, most of the time you won’t need to worry about these but I think\nit is a nice exercise to have it detailed fully like this:</p>\n<p><img src=\"/be05b5e82862d20b8aa6cde5ca810ca4/flow3.svg\" alt=\"OAuth OpenId authorization code flow sequence diagram\"></p>\n<h2 id=\"bonus-what-are-the-access-refresh-and-id-tokens\" style=\"position:relative;\">Bonus: what are the access, refresh and id tokens?<a href=\"#bonus-what-are-the-access-refresh-and-id-tokens\" aria-label=\"bonus what are the access refresh and id tokens permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Each identity provider might use them differently but these are\nsome of the core ideas behind each of them</p>\n<ul>\n<li><em>access token</em>: an opaque value with a short expiration that the identity server uses to identify a user (think of it as a portable session id)</li>\n<li><em>refresh token</em>: another opaque value with a longer expiration that it is used to refresh the access token and the id token. Long lived sessions are typically handled by this two step process to give more control to identity providers.</li>\n<li><em>id token</em>: this is what OpendId Connect adds, this is a self contained jwt that contains claims (attributes) about the identity of the currently logged in user. This is what makes sense the most to use inside your own system to check the identity of the user. You can cryptographically verify its validity and it will contain minimal information such as the <code class=\"language-text\">sub</code> id (the subject id or the user id), the email, the names, etc.</li>\n</ul>\n<h2 id=\"exercise-1\" style=\"position:relative;\">Exercise 1<a href=\"#exercise-1\" aria-label=\"exercise 1 permalink\" class=\"header-anchor after\">#</a></h2>\n<p>How would you implement a “back to” functionality?</p>\n<p>Let’s say that you originally tried to access <code class=\"language-text\">/private/route/1</code> but you weren’t authenticated yet\nso we redirected you to <code class=\"language-text\">/auth/login</code>.\nAfter going through all the auth flow we would like for the app to redirect automatically back\nto <code class=\"language-text\">/private/route/1</code>.</p>\n<details>\n  <summary>Show me the answer</summary>\n<p>See answer <a href=\"https://github.com/franleplant/sso-with-openid/blob/master/src/auth/routes.ts#L31-L43\">here</a>. A couple of notes:</p>\n<ul>\n<li>you basically store a <code class=\"language-text\">backTo</code> param in the state and in the cookie</li>\n<li>you can store more stuff in the <code class=\"language-text\">state</code></li>\n<li>we need it also in the cookie to prevent XSRF.</li>\n<li>Check the <a href=\"https://tools.ietf.org/html/draft-bradley-oauth-jwt-encoded-state-00\">IETF standard</a> and read more <a href=\"https://auth0.com/docs/protocols/state-parameters\">here</a></li>\n</ul>\n</details>\n<h2 id=\"closing\" style=\"position:relative;\">Closing<a href=\"#closing\" aria-label=\"closing permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Did you like the content? Consider sharing it in your social circle and subscribing\nto receive awesome exclusive content right into your email box.</p>","fields":{"slug":"/openid-oauth-authentication-for-nodejs/","readingTime":{"text":"19 min read"}},"frontmatter":{"title":"Authenticating your Node.js app with Google as an OpenId Connect Provider","date":"October 23, 2020","description":"Let's build the basic boilerplate for OpenId Connect based authencation with Google as Identity provider, persistent session cookies, express middleware in Typescript and Node.js","tags":["TypeScript","Javascript","Nodejs","express","OpenId Connect","oidc","OAuth 2.0","middleware","Single Sign On","microservice"],"seoFooter":["Using OpenId Connect to implement Single Sign On across multiple applications.","How to implement persistent cookie session with Express.js,  Node.js and Typescript","OpenId Connect as an authentication provider in a Micro Service Architecture.","OpenId Connect Identity provider for a Single Sign On experience across multiple apps.","Using JWT as self contained sessions in a microservice architecture.","how to use an OpenId auth provider in a microservice architecture?","how OpenId connect works?","how to integrate OpenId auth with browser authentications.","from zero to hero OAuth / OpenId.","using openid connect to integrate authn with microfrontend apps.","implementing SSO via openId.","understanding OpenId Connect by building an app.","Implementing SSO with Google OpenId Connect."],"author":{"id":"franleplant","bio":"Tech Lead and Software developer with a degree in Engineering. Woodworker, all things Javascript, Rust and Software Architecture.","twitter":"franleplant","github":"https://github.com/franleplant","profilepicture":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACjUlEQVQ4y2P4jwH+/fsHJO/curV6xdKjhw9+//4NLogGGND4f//+BZKXL160MDVRUVLSUFZydbBbvHDBf2wAXfOfP3+AZENtjaWqVFGEx/L69HB7I3ERkUMHD8CNJmDzlo3rtrdn/Tww5/+p5Wtb8wUEBCZNnAA3GqdmiN9ePH86uTDmUG/h6vr0LT3Fdrqqpw8TYTNE89dPH84saL+3rPPlpinn5zcdn9Xw//sniDQ+zXCwdWLVqvL4iwtbTs6qPrd1KUgjqrXYNUMUndm9dk9P/obO/OkFYZeP7SVKM9DZf8GhcmDvriw/y3xvwy0tyetm9xw4fPT6tes/f/4iYDMwSJ88eRIREZ7oqDkh07cxL9HT1c3dw9va2nbv3v3IwcaAFlRv375taW0LDY2wtLZ0c7QzMzEys7T18w/KzMrOys5btmIlcmpjQNYJJFvbWgMCgyOjY3z9fH18/ULDIgoKivILimJi41NTUpOSU6/fuAm3nAE5bew9cNDR1T0qJiYkNAQIAgID0zOycnLzw8IjIyIiMzOz4uISdu3ag6IZYu3nz58mtdaWpkYFBwd4eXkFBASGhYUlJaeER0Z5eXsnJCSkpaVFRcVs2LABi+ZVyxafnVN3bUlzYrCHuZWVp6dHeHh4RGSUm7t7TEx0ampaRkYmMCw2bdqE0Ayhbt68GRcXN7+9/MrKnvq0MEtr26CgIP+AACtzE2cnR6CDMzKzkpJSQkPDb968hdAMSeuzZs92cnEODo+IiIqJjY2Ljo6JiYvPTolf3VGQnhgbGh4RFh7u6+tXXV2NHMBQzRMnTdTT03VydnRxdXVxdTMzM7GwsIgIDc5MjvPz9/f19fH29razs9+8eTNyPAMANpkgbLnsUSwAAAAASUVORK5CYII=","aspectRatio":1.1363636363636365,"src":"/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png","srcSet":"/static/3d0df698a9c84ca995878f7c2815d974/69585/franleplant-profile.png 200w,\n/static/3d0df698a9c84ca995878f7c2815d974/497c6/franleplant-profile.png 400w,\n/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png 620w","sizes":"(max-width: 620px) 100vw, 620px"}}}}}}},"pageContext":{"slug":"/openid-oauth-authentication-for-nodejs/","previous":{"fields":{"slug":"/express-route-namespace/"},"frontmatter":{"title":"How to create route namespaces with Express"}},"next":{"fields":{"slug":"/why-i-love-jest/"},"frontmatter":{"title":"Jest makes unit testing fun again"}}}},"staticQueryHashes":["1000388668","1219926595","914163225"]}